<!DOCTYPE html> 
<html>
	<link rel="stylesheet" href="style.css">
<body> 
	
<div class="video-button" data-aperture="closed">
	
    <div class="video-container"  >
		
	<div>
		<img id="img" class = "imgtest" src="../img/qrcode.png" onclick="authenticate()" >
		
		
      <video id='video' class="actual-video" src="../video/宿舍外到內.mp4" ></video>
	  
	  
		
	  </div>
      <div class="play-button__aperture--left"></div>
      <div class="play-button__aperture--top-right"></div>
      <div class="play-button__aperture--bottom-right"></div>
    </div>
    </div>
</body>
<script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.es5.umd.min.js"></script>
<script>
    
    const { startAuthentication } = SimpleWebAuthnBrowser;
	async function authenticate() {
        sessionStorage.clear();
		var test = 0;
		//const elemSuccess = document.querySelector('#authSuccess');
		const elemError = document.querySelector('#authError');
		//const elemDebug = document.querySelector('#authDebug');

		// Reset success/error messages
		//elemSuccess.innerHTML = '';
		//elemError.innerHTML = '';
		//elemDebug.innerHTML = '';
	  
		const resp = await fetch('/generate-authentication-options');

		let asseResp;
		try {
		  const opts = await resp.json();
		  //printDebug(elemDebug, 'Authentication Options', JSON.stringify(opts, null, 2));

		  //hideAuthForm();

		  asseResp = await startAuthentication(opts);
		  //console.log(asseResp);
		  //printDebug(elemDebug, 'Authentication Response', JSON.stringify(asseResp, null, 2));
		} catch (error) {
		  //elemError.innerText = error;
		  alert('Authenticate failed!');
		  throw new Error(error);
		}

		
		const verificationResp = await fetch('/verify-authentication', {
		  method: 'POST',
		  headers: {
			'Content-Type': 'application/json',
		  },
		  body: JSON.stringify(asseResp),
		});

		const verificationJSON = await verificationResp.json();
		//printDebug(elemDebug, 'Server Response', JSON.stringify(verificationJSON, null, 2));
		if (verificationJSON && verificationJSON.verified) {
            let video = document.getElementById('video');
			video.play();
			setTimeout('location.href = "out.html"',9000);
			
		} else {
		  /*elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${JSON.stringify(
			verificationJSON,
		  )}</pre>`;*/
		  alert('Authenticate failed!');
		}
		
		
		
	  };
</script>