<!DOCTYPE html>
<html lang="en">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.es5.umd.min.js"></script>
    <form action="action_page.php" style="border:1px solid #ccc">
    <div class="container">
      <h1>Sign Up</h1>
      <p>Please fill in this form to create an account.</p>
      <hr>
      
      
      <label for="username"><b>User Name</b></label>
      <input type="text" id="username" placeholder="Enter User Name" name="username" required>
      <!--
      <label for="email"><b>Email</b></label>
      <input type="text" id="email" placeholder="Enter Email" name="email" required>
      
      <label for="psw"><b>Password</b></label>
      <input type="password" placeholder="Enter Password" name="psw" required>
  
      <label for="psw-repeat"><b>Repeat Password</b></label>
      <input type="password" placeholder="Repeat Password" name="psw-repeat" required>
      -->

      <label>
        <input type="checkbox" checked="checked" name="remember" style="margin-bottom:15px"> Remember me
      </label>
  
      <p>By creating an account you agree to our <a href="#" style="color:dodgerblue">Terms & Privacy</a>.</p>
  
      <div class="clearfix">
        <button type="button" class="cancelbtn" onclick="history.back()">Cancel</button>
        <button type="button" class="signupbtn" id="btnRegBegin">Sign Up</button>
      </div>
    </div>
  </form>
  
  <script>
      const { startAuthentication } = SimpleWebAuthnBrowser;
      const { browserSupportsWebAuthn, startRegistration } = SimpleWebAuthnBrowser;
      document.querySelector('#btnRegBegin').addEventListener('click', async () => {
//console.log(document.getElementById("username").value)
/*     
          const elemSuccess = document.querySelector('#regSuccess');
          const elemError = document.querySelector('#regError');
          const elemDebug = document.querySelector('#regDebug');

          // Reset success/error messages
          elemSuccess.innerHTML = '';
          elemError.innerHTML = '';
          elemDebug.innerHTML = '';
*/
          const sendvalue = {
            username: document.getElementById("username").value
          };
/*
          await fetch('/testuser', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(sendvalue),
          });
*/
          const resp = await fetch('/generate-registration-options', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(sendvalue),
          });

          let attResp;
          try {
            const opts = await resp.json();
console.log(opts)
//            printDebug(elemDebug, 'Registration Options', JSON.stringify(opts, null, 2));

//            hideAuthForm();

            attResp = await startRegistration(opts);
//console.log(attResp)
//            printDebug(elemDebug, 'Registration Response', JSON.stringify(attResp, null, 2));
          } catch (error) {
            if (error.name === 'InvalidStateError') {
              elemError.innerText = 'Error: Authenticator was probably already registered by user';
            } else {
//              elemError.innerText = error;
            }

            throw error;
          }

          const verificationResp = await fetch('/verify-registration', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(attResp),
          });

          const verificationJSON = await verificationResp.json();
//          printDebug(elemDebug, 'Server Response', JSON.stringify(verificationJSON, null, 2));

          if (verificationJSON && verificationJSON.verified) {
//            elemSuccess.innerHTML = `Authenticator registered!`;
alert('Authenticator register success!');
            location.href = "/index.html";
          } else {
//            elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${JSON.stringify(
//              verificationJSON,
//            )}</pre>`;
          }
      });
  </script>

</html>